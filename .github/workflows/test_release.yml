name: Test and release helm chart

on:
  pull_request:
    paths:
      - 'helm/**'

jobs:
  test_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1

      # - name: Deploy Helm Chart in Kind Cluster
      #   run: run: helm install pdp . --set pdp.ApiKey=${{ secrets.PDP_API_KEY }} --namespace pdp

      - name: Deploy Helm Chart in Kind Cluster
        run: helm install pdp . --set pdp.ApiKey=permit_key_VG0tFLP8PEYcWb3I6oK2InXzmVwlD5VKObp6nDdEDICUBEg55p2Yvr625dleiTgcQdzRS6oofLcLZWUwNCvTYA --namespace pdp

      - name: Show PDP pod status
        run: kubectl get pods -n pdp
        if: always()